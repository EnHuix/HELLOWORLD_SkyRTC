const model = require('../model');
let Moment=model.Moment;

const APIError = require('../rest').APIError;

var gid = 0; //用来唯一标识动态

function nextId() {
    gid ++;
    return 't' + gid;
}

var moments = [
    {
        id: nextId(),
        name: 'Learn Git',
        description: 'Learn how to use git as distributed version control'
    },
    {
        id: nextId(),
        name: 'Learn JavaScript',
        description: 'Learn JavaScript, Node.js, NPM and other libraries'
    },
    {
        id: nextId(),
        name: 'Learn Python',
        description: 'Learn Python, WSGI, asyncio and NumPy'
    },
    {
        id: nextId(),
        name: 'Learn Java',
        description: 'Learn Java, Servlet, Maven and Spring'
    }
];


module.exports = {

    //未完成
    //返回状态的页面
    'GET /moment_page': async (ctx, next) => {
        ctx.render('moment.html', {
            title:"心情"
        });
    },

    //返回所有todo列表
    'GET /moment/moments': async (ctx, next) => {
        ctx.rest({
            moments: moments
        });
    },

    //创建一个新的状态，并返回创建后的对象
    'POST /moment/moments': async (ctx, next) => {
        var
            t = ctx.request.body,
            todo;
        if (!t.name || !t.name.trim()) {
            throw new APIError('invalid_input', 'Missing name');
        }
        if (!t.description || !t.description.trim()) {
            throw new APIError('invalid_input', 'Missing description');
        }
        todo = {
            id: nextId(),
            name: t.name.trim(),
            description: t.description.trim()
        };
        todos.push(todo);
        ctx.rest(todo);
    },

    //更新一个moment，并将更新后的moment返回
    'PUT /moment/moments/:id': async (ctx, next) => {
        var
            t = ctx.request.body,
            index = -1,
            i, todo;
        if (!t.name || !t.name.trim()) {
            throw new APIError('invalid_input', 'Missing name');
        }
        if (!t.description || !t.description.trim()) {
            throw new APIError('invalid_input', 'Missing description');
        }
        for (i=0; i<todos.length; i++) {
            if (todos[i].id === ctx.params.id) {
                index = i;
                break;
            }
        }
        if (index === -1) {
            throw new APIError('notfound', 'Todo not found by id: ' + ctx.params.id);
        }
        todo = todos[index];
        todo.name = t.name.trim();
        todo.description = t.description.trim();
        ctx.rest(todo);
    },

    //删除一个moment
    'DELETE /moment/moments/:id': async (ctx, next) => {
        var i, index = -1;
        for (i=0; i<todos.length; i++) {
            if (todos[i].id === ctx.params.id) {
                index = i;
                break;
            }
        }
        if (index === -1) {
            throw new APIError('notfound', 'Todo not found by id: ' + ctx.params.id);
        }
        ctx.rest(todos.splice(index, 1)[0]);
    },
};  