{% extends "base.html" %} {% block main %}


<script type="text/javascript" src="static/js/SkyRTC-client.js"></script>

<script>

function addToUserList(list, user) {
    var i;
    for (i=0; i<list.length; i++) {
        console.log(user)
        if (list[i].id === user.id) {
            return;
        }
    }
    list.push(user);
}

function removeFromUserList(list, user) {
    var i, target = -1;
    for (i=0; i<list.length; i++) {
        
        if (list[i].id === user.id) {
            target = i;
            break;
        }
    }
    if (target >= 0) {
        list.splice(target, 1);
    }
}

function addMessage(list, msg) {
    list.push(msg);
    $('#message-list').parent().animate({
        scrollTop: $('#message-list').height()
    }, 1000);
}

$(function () {
    var vmMessageList = new Vue({
        el: '#message-list',
        data: {
            messages: []
        }
    });
    var vmUserList = new Vue({
        el: '#user-list',
        data: {
            users: []
        }
    });

    var videos = document.getElementById("videos");

    var msgs = document.getElementById("msgs");

    var rtc = SkyRTC();

    /**********************************************************/
    //成功创建WebSocket连接
    rtc.on("connected", function(socket) {
        //创建本地视频流
        rtc.createStream({
            //"video": true,
            "audio": true
        });

    });
   //创建本地视频流成功
    rtc.on("stream_created", function(stream) {
       
        //document.getElementById('me').srcObject = stream;

        //document.getElementById('me').play();
    });
    //创建本地视频流失败
    rtc.on("stream_create_error", function() {
        alert("create stream failed!");
    });
    //接收到其他用户的视频流
    rtc.on('pc_add_stream', function(stream, socketId) {
        var newVideo = document.createElement("video"),
            id = "other-" + socketId;
        newVideo.setAttribute("class", "other");
        newVideo.setAttribute("autoplay", "autoplay");
        newVideo.setAttribute("id", id);
        videos.appendChild(newVideo);
        rtc.attachStream(stream, id);
    });

    //删除其他用户
    rtc.on('remove_peer', function(socketId) {
        console.log('删除');
       // addMessage(vmMessageList.messages, msg);
        var video = document.getElementById('other-' + socketId);
        if(video){
            video.parentNode.removeChild(video);
        }
    });
    //新用户加入
    rtc.on("new_peer",function(message){
        console.log(message);
        //addToUserList(vmUserList.users, msg.user);
    })
    //接收到文字信息
    rtc.on('data_channel_message', function(channel, socketId, message){
               

      //  console.log(channel,socketId,message);
        message=JSON.stringify({
            type: 'chat',
           // user:  }},
            data: message.trim()
        });
        var msg = JSON.parse(message);
        addMessage(vmMessageList.messages, msg);
        
    });
    $('#form-chat').submit(function (e) {
        e.preventDefault();
        var input = $(this).find('input[type=text]');
        var text = input.val().trim();
        console.log('[chat] ' + text);
        if (text) {
            input.val('');
           // ws.send(text);
            rtc.broadcast(text);
            message=JSON.stringify({
                type: 'chat',
                //user: {{ user }},
                data: text.trim()
            });
            var msg = JSON.parse(message);
            addMessage(vmMessageList.messages, msg);
        }

    });

    //连接WebSocket服务器
    rtc.connect("ws:" + window.location.href.substring(window.location.protocol.length).split('#')[0], window.location.hash.slice(1));



    // var ws = new WebSocket('ws://localhost:3000/ws/chat');

    // ws.onmessage = function(event) {
    //     var data = event.data;
    //     console.log(data);
    //     var msg = JSON.parse(data);
    //     if (msg.type === 'list') {
    //         vmUserList.users = msg.data;
    //     } else if (msg.type === 'join') {
    //         addToUserList(vmUserList.users, msg.user);
    //         addMessage(vmMessageList.messages, msg);
    //     } else if (msg.type === 'left') {
    //         removeFromUserList(vmUserList.users, msg.user);
    //         addMessage(vmMessageList.messages, msg);
    //     } else if (msg.type === 'chat') {
    //         addMessage(vmMessageList.messages, msg);
    //     } 
    // };

    // ws.onclose = function (evt) {
    //     console.log('[closed] ' + evt.code);
    //     var input = $('#form-chat').find('input[type=text]');
    //     input.attr('placeholder', 'WebSocket disconnected.');
    //     input.attr('disabled', 'disabled');
    //     $('#form-chat').find('button').attr('disabled', 'disabled');
    // };

    // ws.onerror = function (code, msg) {
    //     console.log('[ERROR] ' + code + ': ' + msg);
    // };


   
});
</script>
 <div id="videos">
    <video id="me" autoplay></video>
</div>

<div class="container">
    <div class="row">
        <div class="col-md-8">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title"><span class="glyphicon glyphicon-th-list"></span> Room</h3>
                </div>
                <div class="panel-body">
                    <div style="height:400px; overflow-x:hidden; overflow-y:scroll;">
                        <div id="message-list">
                            <div style="margin-bottom:25px;" v-for="msg in messages">
                                <div v-if="msg.type === 'join' || msg.type === 'left'">
                                    <div class="media-left">
                                        <img class="media-object" style="width:20px; height:20px;" v-bind:src="'/static/images/' + msg.user.image  + '.png'">
                                    </div>
                                    <div class="media-body">
                                        <h4 class="media-heading" v-text="msg.data"></h4>
                                    </div>
                                </div>
                                <div v-if="msg.type === 'chat'">
                                    <div class="media">
                                        <div class="media-left">
                                            <img class="media-object" style="width:48px; height:48px;" v-bind:src="'/static/images/' + msg.user.image + '.png'">
                                        </div>
                                        <div class="media-body">
                                            <h4 class="media-heading" v-text="msg.user.name"></h4>
                                            <span v-text="msg.data"></span>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                    <div>
                        <form id="form-chat" action="#0">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="A good day, isn't it?">
                                
                                <span class="input-group-btn"><button class="btn btn-default" type="submit">Go</button></span>
                            </div>
                        </form>
                        <!-- <form id="form-audio" action="#0">
                            <div class="input-group">
                                <span class="input-group-btn"><button id="send" class="btn btn-default" type="submit">Send</button></span>
                                <span class="input-group-btn"><button id="record" class="btn btn-default" type="submit">Start Recording</button></span>
                                <span class="input-group-btn"><button id="play" class="btn btn-default" type="submit">Play</button></span>
                            </div>
                        </form> -->
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title"><span class="glyphicon glyphicon-user"></span> Users</h3>
                </div>
                <div class="panel-body">
                    <div style="height:434px; overflow-x:hidden; overflow-y:scroll;">
                        <div id="user-list">
                            <div class="media" v-for="user in users">
                                <div class="media-left">
                                    <img class="media-object" style="width:20px; height:20px;" v-bind:src="'/static/images/' + user.image + '.png'">
                                </div>
                                <div class="media-body">
                                    <h4 class="media-heading" v-text="user.name + ' (' + user.id + ')'"></h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <audio id="recorded" preload="none"></audio>
        <!-- <button type="button" class="btn btn-info" onclick="location.href='/test'">test</button> -->
    </div>    
</div>
<!-- <script src="/static/js/record.js"></script> -->
{% endblock %}